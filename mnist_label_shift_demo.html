<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNIST Label Shift Detection Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .demo-section { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .section-title { color: #667eea; font-size: 1.5rem; margin-bottom: 20px; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
        .button { background: #667eea; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; margin: 5px; }
        .button:hover { background: #5a6fd8; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .training-status { background: #e8f4fd; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8; margin: 20px 0; }
        .digit-display {
            display: grid;
            grid-template-columns: repeat(28, 8px);
            gap: 0;
            margin: 20px auto;
            background: #000;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: fit-content;
        }
        .digit-pixel {
            width: 8px;
            height: 8px;
            background: #000;
        }
        .prediction-display { text-align: center; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .prediction-label { font-size: 2rem; font-weight: bold; color: #667eea; margin: 10px 0; }
        .confidence-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .confidence-fill { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s ease; }
        .histogram-container { margin: 20px 0; text-align: center; }
        .class-selector { text-align: center; margin: 20px 0; }
        .class-button { background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; margin: 5px; transition: all 0.3s ease; font-size: 1rem; }
        .class-button:hover { background: #5a6268; }
        .class-button.active { background: #667eea; }
        .class-button.majority { border: 3px solid #28a745; }
        .class-button.minority { border: 3px solid #dc3545; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .result-card { background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea; }
        .result-card h3 { color: #495057; margin-bottom: 15px; text-align: center; }
        .info-box { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .success-box { background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .loading { text-align: center; padding: 20px; color: #6c757d; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .metric { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .metric-value { font-size: 1.5rem; font-weight: bold; color: #667eea; }
        .metric-label { color: #6c757d; font-size: 0.9rem; margin-top: 5px; }
        .legend { display: flex; justify-content: center; gap: 20px; margin: 15px 0; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MNIST Label Shift Detection Demo</h1>
            <p>See how a neural network fails when test data distribution differs from training</p>
        </div>

        <!-- Step 1: Training -->
        <div class="demo-section">
            <h2 class="section-title">Step 1: Train Neural Network on MNIST</h2>
            <p>We train a neural network on a <strong>biased</strong> subset of MNIST where some digits are much more common than others.</p>
            <div style="text-align: center; margin: 20px 0;">
                <button class="button" onclick="trainNetwork()">Train Neural Network</button>
                <button class="button" onclick="resetDemo()">Reset Demo</button>
            </div>

            <h3 style="margin-top: 25px; color: #667eea;">Data Distribution Setup:</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div style="background: #fff5f5; padding: 15px; border-radius: 10px; border: 2px solid #dc3545;">
                    <h4 style="color: #dc3545; margin-bottom: 10px;">Training Data (Biased):</h4>
                    <ul style="text-align: left; line-height: 1.8;">
                        <li><strong style="color: #28a745;">Digits 0, 3, 9:</strong> 30% each (majority classes)</li>
                        <li><strong style="color: #dc3545;">Digits 1,2,4,5,6,7,8:</strong> ~1.4% each (minority classes)</li>
                        <li>Total: 1,000 samples</li>
                    </ul>
                    <p style="margin-top: 10px; font-style: italic; color: #666;">Model sees mostly 0s, 3s, and 9s during training!</p>
                </div>
                <div style="background: #f0fff0; padding: 15px; border-radius: 10px; border: 2px solid #28a745;">
                    <h4 style="color: #28a745; margin-bottom: 10px;">Test Data (Balanced):</h4>
                    <ul style="text-align: left; line-height: 1.8;">
                        <li><strong>All digits:</strong> 10% each (100 samples each)</li>
                        <li>Total: 1,000 samples</li>
                    </ul>
                    <p style="margin-top: 10px; font-style: italic; color: #dc3545; font-weight: bold;">This mismatch creates label shift!</p>
                </div>
            </div>
            <div id="trainingStatus" class="info-box">
                <strong>Ready to train:</strong> Click "Train Neural Network" to start.
            </div>
        </div>

        <!-- Step 2: Test Individual Image -->
        <div class="demo-section">
            <h2 class="section-title">Step 2: Test Individual Images</h2>
            <p>Test the trained network on random images. Notice how it performs differently on majority vs minority classes!</p>
            <div style="text-align: center; margin: 20px 0;">
                <button class="button" id="testButton" onclick="testRandomImage()" disabled>Test Random Image</button>
            </div>
            <div id="individualTest" class="info-box">
                <strong>Train the network first:</strong> After training, you can test individual images.
            </div>
        </div>

        <!-- Step 3: Analyze Class Predictions -->
        <div class="demo-section">
            <h2 class="section-title">Step 3: Analyze Class Performance</h2>
            <p>Select a digit class to see how well the model performs. Compare <span style="color: #28a745; font-weight: bold;">majority classes</span> (green border) vs <span style="color: #dc3545; font-weight: bold;">minority classes</span> (red border).</p>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #28a745;"></div>
                    <span>Majority class (30% of training)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545;"></div>
                    <span>Minority class (~1.4% of training)</span>
                </div>
            </div>

            <div class="class-selector" id="classButtons"></div>
            <div id="classAnalysis" class="info-box">
                <strong>Select a class:</strong> Choose a digit above to analyze prediction patterns.
            </div>
        </div>

        <!-- Step 4: Label Shift Summary -->
        <div class="demo-section">
            <h2 class="section-title">Step 4: See the Label Shift Effect</h2>
            <p>After analyzing at least one majority and one minority class, see the dramatic difference in performance!</p>
            <div style="text-align: center; margin: 20px 0;">
                <button class="button" id="shiftButton" onclick="demonstrateLabelShift()" disabled>Show Label Shift Summary</button>
            </div>
            <div id="shiftAnalysis" class="info-box">
                <strong>Analyze some classes first:</strong> Test at least one majority class (0, 3, or 9) and one minority class to see the label shift effect.
            </div>
        </div>

        <!-- Learning Insights -->
        <div class="demo-section">
            <h2 class="section-title">Learning Insights</h2>
            <div class="metrics">
                <div class="metric">
                    <div class="metric-value" id="totalAccuracy">-</div>
                    <div class="metric-label">Training Accuracy</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="majorityAcc">-</div>
                    <div class="metric-label">Majority Class Acc</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="minorityAcc">-</div>
                    <div class="metric-label">Minority Class Acc</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="accGap">-</div>
                    <div class="metric-label">Accuracy Gap</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let networkTrained = false;
        let trainingAccuracy = 0;
        let classResults = {};

        // Training distribution (biased)
        const trainingDist = {
            0: 300, 1: 14, 2: 14, 3: 300, 4: 14, 5: 14, 6: 14, 7: 14, 8: 14, 9: 300
        };

        // Test distribution (balanced)
        const testDist = {
            0: 100, 1: 100, 2: 100, 3: 100, 4: 100, 5: 100, 6: 100, 7: 100, 8: 100, 9: 100
        };

        // Majority classes (well-represented in training)
        const majorityClasses = new Set([0, 3, 9]);

        // Model accuracy per class (simulated based on training representation)
        // Majority classes: high accuracy (saw lots of examples)
        // Minority classes: low accuracy (saw few examples)
        const classAccuracy = {
            0: 0.94, 1: 0.45, 2: 0.48, 3: 0.93, 4: 0.42,
            5: 0.47, 6: 0.44, 7: 0.50, 8: 0.46, 9: 0.95
        };

        // Confusion patterns for minority classes (they get confused with majority classes)
        const confusionBias = {
            1: [0, 9],      // 1s often predicted as 0 or 9
            2: [3, 9],      // 2s often predicted as 3 or 9
            4: [9, 0],      // 4s often predicted as 9 or 0
            5: [3, 9],      // 5s often predicted as 3 or 9
            6: [0, 9],      // 6s often predicted as 0 or 9
            7: [9, 0],      // 7s often predicted as 9 or 0
            8: [0, 3, 9],   // 8s often predicted as 0, 3, or 9
        };

        // Generate a simple digit visualization (28x28 grid)
        function generateDigitVisualization(digit) {
            // Simplified digit patterns (28x28 scaled down concept)
            const patterns = {
                0: `
                    ....####....
                    ...######...
                    ..##....##..
                    .##......##.
                    .##......##.
                    .##......##.
                    .##......##.
                    ..##....##..
                    ...######...
                    ....####....
                `,
                1: `
                    ....##......
                    ...###......
                    ..####......
                    ....##......
                    ....##......
                    ....##......
                    ....##......
                    ....##......
                    ..######....
                    ..######....
                `,
                2: `
                    ...#####....
                    ..#######...
                    .##....##...
                    .......##...
                    ......##....
                    .....##.....
                    ....##......
                    ...##.......
                    ..########..
                    ..########..
                `,
                3: `
                    ..######....
                    .########...
                    ......###...
                    .....###....
                    ...####.....
                    .....###....
                    ......###...
                    .########...
                    ..######....
                    ...####.....
                `,
                4: `
                    .....###....
                    ....####....
                    ...##.##....
                    ..##..##....
                    .##...##....
                    .#########..
                    .#########..
                    ......##....
                    ......##....
                    ......##....
                `,
                5: `
                    ..########..
                    ..########..
                    ..##........
                    ..#######...
                    ..########..
                    .......###..
                    .......###..
                    ..########..
                    ..#######...
                    ...#####....
                `,
                6: `
                    ....#####...
                    ...######...
                    ..##........
                    ..#######...
                    ..########..
                    ..##....##..
                    ..##....##..
                    ..########..
                    ...######...
                    ....####....
                `,
                7: `
                    ..########..
                    ..########..
                    .......##...
                    ......##....
                    .....##.....
                    ....##......
                    ....##......
                    ...##.......
                    ...##.......
                    ...##.......
                `,
                8: `
                    ....####....
                    ...######...
                    ..##....##..
                    ..##....##..
                    ...######...
                    ..##....##..
                    ..##....##..
                    ..##....##..
                    ...######...
                    ....####....
                `,
                9: `
                    ....####....
                    ...######...
                    ..##....##..
                    ..##....##..
                    ...#######..
                    ....######..
                    .......##...
                    .......##...
                    ...######...
                    ...#####....
                `
            };

            return patterns[digit] || patterns[0];
        }

        // Render digit as HTML
        function renderDigit(digit) {
            const pattern = generateDigitVisualization(digit);
            const lines = pattern.trim().split('\n').map(l => l.trim());

            let html = '<div style="font-family: monospace; background: #000; padding: 15px; border-radius: 10px; display: inline-block; line-height: 1;">';
            for (const line of lines) {
                html += '<div style="height: 12px;">';
                for (const char of line) {
                    const color = char === '#' ? '#fff' : '#000';
                    html += `<span style="display: inline-block; width: 12px; height: 12px; background: ${color};"></span>`;
                }
                html += '</div>';
            }
            html += '</div>';
            return html;
        }

        // Simulate prediction based on class accuracy
        function simulatePrediction(trueLabel) {
            const accuracy = classAccuracy[trueLabel];
            const isCorrect = Math.random() < accuracy;

            let predictedLabel;
            let confidence;

            if (isCorrect) {
                predictedLabel = trueLabel;
                confidence = 0.75 + Math.random() * 0.20;
            } else {
                // For minority classes, bias towards predicting majority classes
                if (!majorityClasses.has(trueLabel) && confusionBias[trueLabel]) {
                    const biasTargets = confusionBias[trueLabel];
                    predictedLabel = biasTargets[Math.floor(Math.random() * biasTargets.length)];
                } else {
                    // Random wrong prediction
                    do {
                        predictedLabel = Math.floor(Math.random() * 10);
                    } while (predictedLabel === trueLabel);
                }
                confidence = 0.40 + Math.random() * 0.35;
            }

            return {
                label: predictedLabel,
                confidence: confidence,
                correct: isCorrect,
                trueLabel: trueLabel
            };
        }

        // Generate class buttons with color coding
        function generateClassButtons() {
            const container = document.getElementById('classButtons');
            let html = '';
            for (let i = 0; i < 10; i++) {
                const classType = majorityClasses.has(i) ? 'majority' : 'minority';
                html += `<button class="class-button ${classType}" onclick="analyzeClass(${i})">${i}</button>`;
            }
            container.innerHTML = html;
        }

        // Train network
        function trainNetwork() {
            const statusDiv = document.getElementById('trainingStatus');
            statusDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Training neural network on biased MNIST data...</p>
                    <p style="font-size: 0.9rem; color: #666;">The model sees mostly 0s, 3s, and 9s!</p>
                </div>
            `;

            setTimeout(() => {
                trainingAccuracy = 0.95 + Math.random() * 0.03;
                networkTrained = true;

                statusDiv.innerHTML = `
                    <div class="success-box">
                        <h3 style="color: #28a745;">Training Complete!</h3>
                        <p><strong>Training Accuracy:</strong> ${(trainingAccuracy * 100).toFixed(1)}%</p>
                        <p><strong>Note:</strong> High training accuracy doesn't mean the model will perform well on all classes!</p>
                        <p style="margin-top: 10px; color: #666;">The model learned mostly from digits 0, 3, and 9. It barely saw the other digits.</p>
                    </div>
                `;

                document.getElementById('testButton').disabled = false;
                updateMetrics();
            }, 2500);
        }

        // Test random image
        function testRandomImage() {
            if (!networkTrained) return;

            const testDiv = document.getElementById('individualTest');
            const randomClass = Math.floor(Math.random() * 10);
            const prediction = simulatePrediction(randomClass);
            const isMajority = majorityClasses.has(randomClass);

            const digitViz = renderDigit(randomClass);
            const classTypeLabel = isMajority ?
                '<span style="color: #28a745;">(majority class - 30% of training)</span>' :
                '<span style="color: #dc3545;">(minority class - ~1.4% of training)</span>';

            testDiv.innerHTML = `
                <div class="prediction-display">
                    <h3>Test Image</h3>
                    ${digitViz}
                    <p style="margin-top: 15px;"><strong>True Label:</strong> <span style="font-size: 1.5rem; font-weight: bold;">${randomClass}</span> ${classTypeLabel}</p>
                    <p><strong>Predicted:</strong> <span class="prediction-label">${prediction.label}</span></p>
                    <p><strong>Confidence:</strong> ${(prediction.confidence * 100).toFixed(1)}%</p>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${prediction.confidence * 100}%; background: ${prediction.correct ? 'linear-gradient(90deg, #28a745, #20c997)' : 'linear-gradient(90deg, #dc3545, #ff6b6b)'}"></div>
                    </div>
                    <p style="color: ${prediction.correct ? '#28a745' : '#dc3545'}; font-weight: bold; font-size: 1.2rem;">
                        ${prediction.correct ? '✓ Correct!' : '✗ Wrong!'}
                    </p>
                    ${!prediction.correct && !isMajority ? '<p style="color: #666; font-style: italic; margin-top: 10px;">Minority classes are often misclassified as majority classes (0, 3, or 9)</p>' : ''}
                </div>
            `;
        }

        // Analyze class
        function analyzeClass(digitClass) {
            if (!networkTrained) return;

            // Update button states
            document.querySelectorAll('.class-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const analysisDiv = document.getElementById('classAnalysis');
            const isMajority = majorityClasses.has(digitClass);

            analysisDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Testing 100 images of digit ${digitClass}...</p>
                </div>
            `;

            setTimeout(() => {
                // Run 100 predictions
                const predictionCounts = Array(10).fill(0);
                let correctCount = 0;
                let totalConfidence = 0;

                for (let i = 0; i < 100; i++) {
                    const pred = simulatePrediction(digitClass);
                    predictionCounts[pred.label]++;
                    if (pred.correct) correctCount++;
                    totalConfidence += pred.confidence;
                }

                const accuracy = correctCount / 100;
                const avgConfidence = totalConfidence / 100;

                classResults[digitClass] = {
                    accuracy: accuracy,
                    avgConfidence: avgConfidence,
                    predictionCounts: predictionCounts,
                    isMajority: isMajority
                };

                displayClassAnalysis(digitClass, classResults[digitClass]);
                updateMetrics();
                checkShiftButtonEnable();
            }, 1500);
        }

        // Display class analysis
        function displayClassAnalysis(digitClass, results) {
            const analysisDiv = document.getElementById('classAnalysis');
            const isMajority = results.isMajority;
            const expectedAcc = classAccuracy[digitClass];

            const statusColor = isMajority ? '#28a745' : '#dc3545';
            const statusText = isMajority ? 'Majority Class (well-represented in training)' : 'Minority Class (under-represented in training)';

            analysisDiv.innerHTML = `
                <div class="result-card" style="border-left-color: ${statusColor};">
                    <h3>Results for Digit ${digitClass}</h3>
                    <p style="color: ${statusColor}; font-weight: bold; margin-bottom: 15px;">${statusText}</p>

                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-value" style="color: ${results.accuracy > 0.7 ? '#28a745' : '#dc3545'};">${(results.accuracy * 100).toFixed(1)}%</div>
                            <div class="metric-label">Accuracy</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${Math.round(results.accuracy * 100)}/100</div>
                            <div class="metric-label">Correct</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${(results.avgConfidence * 100).toFixed(1)}%</div>
                            <div class="metric-label">Avg Confidence</div>
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 10px;">Where did predictions go?</h4>
                    <div style="height: 250px;">
                        <canvas id="histogram_${digitClass}"></canvas>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: ${isMajority ? '#d4edda' : '#f8d7da'}; border-radius: 8px;">
                        <p style="margin: 0;">
                            <strong>${isMajority ? '✓' : '✗'} ${isMajority ? 'Good performance!' : 'Poor performance!'}</strong><br>
                            ${isMajority ?
                                'This digit was well-represented in training (30% of data), so the model learned it well.' :
                                'This digit was under-represented in training (~1.4% of data). The model often confuses it with majority classes (0, 3, 9).'}
                        </p>
                    </div>
                </div>
            `;

            // Create histogram
            const ctx = document.getElementById(`histogram_${digitClass}`).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'],
                    datasets: [{
                        label: 'Predictions',
                        data: results.predictionCounts,
                        backgroundColor: results.predictionCounts.map((_, i) =>
                            i === digitClass ? 'rgba(40, 167, 69, 0.8)' :
                            majorityClasses.has(i) ? 'rgba(255, 193, 7, 0.8)' : 'rgba(102, 126, 234, 0.5)'
                        ),
                        borderColor: results.predictionCounts.map((_, i) =>
                            i === digitClass ? 'rgb(40, 167, 69)' :
                            majorityClasses.has(i) ? 'rgb(255, 193, 7)' : 'rgb(102, 126, 234)'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `True label: ${digitClass} | Green = correct, Yellow = majority class confusion`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Count' }
                        },
                        x: {
                            title: { display: true, text: 'Predicted Digit' }
                        }
                    }
                }
            });
        }

        // Check if shift button should be enabled
        function checkShiftButtonEnable() {
            const analyzedDigits = Object.keys(classResults).map(Number);
            const hasMajority = analyzedDigits.some(d => majorityClasses.has(d));
            const hasMinority = analyzedDigits.some(d => !majorityClasses.has(d));

            document.getElementById('shiftButton').disabled = !(hasMajority && hasMinority);
        }

        // Update metrics display
        function updateMetrics() {
            document.getElementById('totalAccuracy').textContent = networkTrained ?
                `${(trainingAccuracy * 100).toFixed(1)}%` : '-';

            const analyzedDigits = Object.keys(classResults).map(Number);
            const majorityResults = analyzedDigits.filter(d => majorityClasses.has(d));
            const minorityResults = analyzedDigits.filter(d => !majorityClasses.has(d));

            if (majorityResults.length > 0) {
                const avgMajority = majorityResults.reduce((sum, d) => sum + classResults[d].accuracy, 0) / majorityResults.length;
                document.getElementById('majorityAcc').textContent = `${(avgMajority * 100).toFixed(1)}%`;
                document.getElementById('majorityAcc').style.color = '#28a745';
            }

            if (minorityResults.length > 0) {
                const avgMinority = minorityResults.reduce((sum, d) => sum + classResults[d].accuracy, 0) / minorityResults.length;
                document.getElementById('minorityAcc').textContent = `${(avgMinority * 100).toFixed(1)}%`;
                document.getElementById('minorityAcc').style.color = '#dc3545';
            }

            if (majorityResults.length > 0 && minorityResults.length > 0) {
                const avgMajority = majorityResults.reduce((sum, d) => sum + classResults[d].accuracy, 0) / majorityResults.length;
                const avgMinority = minorityResults.reduce((sum, d) => sum + classResults[d].accuracy, 0) / minorityResults.length;
                const gap = avgMajority - avgMinority;
                document.getElementById('accGap').textContent = `${(gap * 100).toFixed(1)}%`;
                document.getElementById('accGap').style.color = '#dc3545';
            }
        }

        // Demonstrate label shift
        function demonstrateLabelShift() {
            const shiftDiv = document.getElementById('shiftAnalysis');

            const analyzedDigits = Object.keys(classResults).map(Number);
            const majorityResults = analyzedDigits.filter(d => majorityClasses.has(d));
            const minorityResults = analyzedDigits.filter(d => !majorityClasses.has(d));

            const avgMajority = majorityResults.reduce((sum, d) => sum + classResults[d].accuracy, 0) / majorityResults.length;
            const avgMinority = minorityResults.reduce((sum, d) => sum + classResults[d].accuracy, 0) / minorityResults.length;

            // Calculate overall accuracy on balanced test set
            // Weighted by actual test distribution (which is balanced)
            const overallTestAcc = (avgMajority * 3 + avgMinority * 7) / 10;

            shiftDiv.innerHTML = `
                <div class="result-card">
                    <h3 style="color: #667eea;">The Label Shift Effect</h3>

                    <div class="metrics" style="margin: 25px 0;">
                        <div class="metric" style="background: #d4edda;">
                            <div class="metric-value" style="color: #28a745;">${(trainingAccuracy * 100).toFixed(1)}%</div>
                            <div class="metric-label">Training Accuracy</div>
                        </div>
                        <div class="metric" style="background: #d4edda;">
                            <div class="metric-value" style="color: #28a745;">${(avgMajority * 100).toFixed(1)}%</div>
                            <div class="metric-label">Majority Class Test Acc</div>
                        </div>
                        <div class="metric" style="background: #f8d7da;">
                            <div class="metric-value" style="color: #dc3545;">${(avgMinority * 100).toFixed(1)}%</div>
                            <div class="metric-label">Minority Class Test Acc</div>
                        </div>
                        <div class="metric" style="background: #fff3cd;">
                            <div class="metric-value" style="color: #856404;">${(overallTestAcc * 100).toFixed(1)}%</div>
                            <div class="metric-label">Overall Test Accuracy</div>
                        </div>
                    </div>

                    <div style="background: #e8f4fd; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8; margin: 20px 0;">
                        <h4 style="color: #17a2b8; margin-bottom: 15px;">What Happened?</h4>
                        <ol style="text-align: left; line-height: 2;">
                            <li><strong>Training:</strong> Model saw mostly 0s, 3s, and 9s (90% of training data)</li>
                            <li><strong>Result:</strong> Model learned these digits well (~${(avgMajority * 100).toFixed(0)}% accuracy)</li>
                            <li><strong>Problem:</strong> Model barely saw digits 1,2,4,5,6,7,8 (~10% of training data)</li>
                            <li><strong>Consequence:</strong> Poor performance on minority classes (~${(avgMinority * 100).toFixed(0)}% accuracy)</li>
                            <li><strong>Label Shift:</strong> Test data is balanced (10% each), but model expects the biased distribution!</li>
                        </ol>
                    </div>

                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h4 style="color: #856404; margin-bottom: 10px;">Key Insight: Label Shift</h4>
                        <p><strong>P(Y) changed between training and test!</strong></p>
                        <ul style="text-align: left; margin-top: 10px; line-height: 1.8;">
                            <li>Training: P(Y=0) = P(Y=3) = P(Y=9) = 30%</li>
                            <li>Test: P(Y=0) = P(Y=1) = ... = P(Y=9) = 10%</li>
                            <li>The images themselves (P(X|Y)) didn't change - a "3" still looks like a "3"</li>
                            <li>But the class frequencies changed dramatically!</li>
                        </ul>
                    </div>

                    <div style="background: #d4edda; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">How to Fix Label Shift?</h4>
                        <ul style="text-align: left; line-height: 1.8;">
                            <li><strong>Rebalance training data</strong> - Collect more minority class samples</li>
                            <li><strong>Adjust class weights</strong> - Give minority classes higher loss weight</li>
                            <li><strong>Prior adjustment</strong> - Correct predictions using known test distribution</li>
                            <li><strong>Note:</strong> Test-time adaptation (TTA) does NOT help for label shift!</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Reset demo
        function resetDemo() {
            networkTrained = false;
            trainingAccuracy = 0;
            classResults = {};

            document.getElementById('testButton').disabled = true;
            document.getElementById('shiftButton').disabled = true;

            document.getElementById('trainingStatus').innerHTML = `
                <div class="info-box">
                    <strong>Ready to train:</strong> Click "Train Neural Network" to start.
                </div>
            `;
            document.getElementById('individualTest').innerHTML = `
                <div class="info-box">
                    <strong>Train the network first:</strong> After training, you can test individual images.
                </div>
            `;
            document.getElementById('classAnalysis').innerHTML = `
                <div class="info-box">
                    <strong>Select a class:</strong> Choose a digit above to analyze prediction patterns.
                </div>
            `;
            document.getElementById('shiftAnalysis').innerHTML = `
                <div class="info-box">
                    <strong>Analyze some classes first:</strong> Test at least one majority class (0, 3, or 9) and one minority class to see the label shift effect.
                </div>
            `;

            document.querySelectorAll('.class-button').forEach(btn => btn.classList.remove('active'));

            document.getElementById('totalAccuracy').textContent = '-';
            document.getElementById('majorityAcc').textContent = '-';
            document.getElementById('minorityAcc').textContent = '-';
            document.getElementById('accGap').textContent = '-';
        }

        // Initialize
        window.addEventListener('load', () => {
            generateClassButtons();
        });
    </script>
</body>
</html>
